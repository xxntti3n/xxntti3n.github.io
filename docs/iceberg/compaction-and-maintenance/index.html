<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Iceberg Compaction and Maintenance — Deep Dive | xxntti3n</title>
  <meta name="description" content="Expire snapshots, rewrite manifests, rewrite data files, and delete orphan files. Keep metadata and storage healthy with examples.">
  <meta name="author" content="Tien Nguyen">

  <!-- Open Graph -->
  <meta property="og:title" content="Iceberg Compaction and Maintenance — Deep Dive">
  <meta property="og:description" content="Expire snapshots, rewrite manifests, rewrite data files, and delete orphan files. Keep metadata and storage healthy with examples.">
  <meta property="og:type" content="article">
  <meta property="og:url" content="https://xxntti3n.github.io/iceberg/compaction-and-maintenance/">
  <meta property="og:image" content="https://xxntti3n.github.io/assets/og-default.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Spectral:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- RSS Feed -->
  <link rel="alternate" type="application/atom+xml" title="xxntti3n" href="/feed.xml">
  <link rel="icon" type="image/svg+xml" href="/assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon.png">

  <!-- Prism for syntax highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>

  <style>
    :root {
      /* Background Colors */
      --bg-primary: #fafafa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #f5f7f9;

      /* Text Colors */
      --text-primary: #0d1117;
      --text-secondary: #3b4252;
      --text-tertiary: #6e7681;

      /* Accent Colors */
      --accent: #FF6719;
      --accent-hover: #e55a15;

      /* Border Colors */
      --border: #e5e9ef;
      --border-light: #f0f3f6;

      /* Code Block */
      --code-bg: #1e1e1e;
      --quote-bg: #fffbf0;
      --quote-border: #FF6719;

      /* Link Colors */
      --link-color: #0969da;
      --link-hover: #FF6719;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);

      /* Gradients */
      --gradient-hero: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #FF6719 100%);
      --gradient-warm: linear-gradient(135deg, #FF6719 0%, #ff8c42 100%);

      /* Typography */
      --font-serif: 'Spectral', Georgia, 'Times New Roman', serif;
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-mono: 'SF Mono', 'Monaco', 'Menlo', 'Consolas', monospace;

      /* Spacing */
      --max-width: 1200px;
      --content-width: 700px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }

    /* Dark Theme */
    .dark-theme {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --bg-tertiary: #21262d;

      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-tertiary: #6e7681;

      --border: rgba(255, 255, 255, 0.1);
      --border-light: rgba(255, 255, 255, 0.05);

      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.5);

      --quote-bg: rgba(255, 103, 25, 0.1);
      --link-color: #58a6ff;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
      font-size: 16px;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: var(--font-serif);
      line-height: 1.7;
      color: var(--text-primary);
      background: var(--bg-primary);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    ::selection {
      background: rgba(255, 103, 25, 0.2);
      color: var(--text-primary);
    }

    .page-wrapper {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 0 24px;
      width: 100%;
    }

    .content-wrapper {
      max-width: var(--content-width);
      margin: 0 auto;
    }

    /* Progress Bar */
    .progress-bar {
      position: fixed;
      top: 0;
      left: 0;
      height: 3px;
      background: var(--gradient-hero);
      width: 0%;
      z-index: 1000;
      transition: width 0.15s ease-out;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }

    /* Back to top */
    .back-to-top {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 44px;
      height: 44px;
      background: var(--gradient-hero);
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
    }

    .back-to-top.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .back-to-top:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
    }

    .back-to-top svg {
      width: 20px;
      height: 20px;
    }

    /* Breadcrumbs - compact */
    .breadcrumbs {
      padding: 12px 0;
      font-family: var(--font-sans);
      font-size: 13px;
    }

    .breadcrumbs a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s ease;
    }

    .dark-theme .breadcrumbs a {
      color: #8b949e;
    }

    .breadcrumbs a:hover {
      color: var(--accent);
    }

    .breadcrumbs span {
      color: var(--text-tertiary);
      margin: 0 8px;
    }

    .breadcrumbs .current {
      color: var(--text-tertiary);
    }

    .article-back-link {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-tertiary);
      text-decoration: none;
      margin-bottom: 16px;
      transition: color 0.2s ease;
    }

    .article-back-link:hover {
      color: var(--accent);
    }

    /* Article Layout - cleaner, less stuffed */
    .article-layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 40px;
      max-width: 900px;
      margin: 0 auto;
      position: relative;
      padding: 24px 24px 48px;
    }

    @media (max-width: 1024px) {
      .article-layout {
        grid-template-columns: 1fr;
        gap: 24px;
        padding: 20px 20px 40px;
      }
    }

    /* Article Header - compact */
    .article-header {
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 28px;
    }

    .article-title {
      font-family: var(--font-serif);
      font-size: clamp(26px, 3.5vw, 38px);
      font-weight: 700;
      line-height: 1.25;
      margin: 0 0 12px;
      color: var(--text-primary);
    }

    .article-subtitle {
      font-family: var(--font-serif);
      font-size: 17px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 0 0 20px 0;
    }

    .article-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 24px;
      align-items: center;
    }

    .article-author {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .article-author-avatar {
      width: 36px;
      height: 36px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      font-family: var(--font-sans);
      font-weight: 700;
      font-size: 14px;
    }

    .article-author-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .article-author-name {
      font-family: var(--font-sans);
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .article-date {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .article-reading-time {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Article Content */
    .article-content {
      font-family: var(--font-serif);
      font-size: 17px;
      line-height: 1.75;
      color: var(--text-primary);
    }

    .article-content h1 {
      font-family: var(--font-serif);
      font-size: 32px;
      font-weight: 700;
      margin: 32px 0 20px;
      padding-bottom: 12px;
    }

    .article-content h2 {
      font-family: var(--font-serif);
      font-size: 26px;
      font-weight: 600;
      margin: 28px 0 16px;
      padding-bottom: 8px;
      scroll-margin-top: 80px;
    }

    .article-content h3 {
      font-family: var(--font-serif);
      font-size: 22px;
      font-weight: 600;
      margin: 24px 0 12px;
      scroll-margin-top: 80px;
    }

    .article-content h4 {
      font-family: var(--font-serif);
      font-size: 18px;
      font-weight: 600;
      margin: 20px 0 12px;
    }

    .article-content p {
      margin-bottom: 16px;
    }

    .article-content ul, .article-content ol {
      margin: 16px 0;
      padding-left: 24px;
      line-height: 1.8;
    }

    .article-content li {
      margin-bottom: 8px;
    }

    .article-content a {
      color: var(--link-color);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s ease;
    }

    .article-content a:hover {
      border-bottom-color: var(--link-hover);
    }

    /* Code Blocks */
    .article-content pre {
      background: var(--code-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin: 20px 0;
      overflow-x: auto;
      max-width: 100%;
      font-size: 13px;
      line-height: 1.5;
    }

    .article-content pre code {
      font-size: inherit;
      background: transparent;
      padding: 0;
    }

    .article-content code {
      font-family: var(--font-mono);
      font-size: 14px;
      background: var(--bg-tertiary);
      padding: 3px 6px;
      border-radius: 4px;
    }

    .dark-theme .article-content code {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Blockquote */
    .article-content blockquote {
      background: var(--quote-bg);
      border-left: 4px solid var(--quote-border);
      padding: 16px 20px;
      margin: 20px 0;
      border-radius: var(--radius-sm);
    }

    .article-content blockquote strong {
      color: var(--text-primary);
    }

    /* Inline Code */
    .article-content p code,
    .article-content li code {
      background: var(--bg-tertiary);
      color: var(--accent);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.9em;
    }

    .dark-theme .article-content p code,
    .dark-theme .article-content li code {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Diagrams */
    .article-content pre.mermaid {
      background: transparent;
      padding: 0;
      text-align: center;
    }

    /* TOC Sidebar - slimmer */
    .toc-sidebar {
      position: sticky;
      top: 88px;
      height: fit-content;
      align-self: start;
    }

    @media (max-width: 1024px) {
      .toc-sidebar {
        position: static;
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid var(--border);
      }
    }

    .toc-title {
      font-family: var(--font-sans);
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-tertiary);
      margin: 0 0 16px;
    }

    .toc-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .toc-list li {
      margin-bottom: 6px;
    }

    .toc-list a {
      font-family: var(--font-sans);
      font-size: 13px;
      color: var(--text-secondary);
      text-decoration: none;
      display: block;
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }

    .dark-theme .toc-list a {
      color: #8b949e;
    }

    .toc-list a:hover,
    .toc-list a.active {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border-left-color: var(--accent);
    }

    .dark-theme .toc-list a:hover,
    .dark-theme .toc-list a.active {
      background: rgba(255, 255, 255, 0.05);
    }

    /* Author Bio - compact */
    .author-bio {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 16px 20px;
      margin: 32px 0 24px;
    }

    .dark-theme .author-bio {
      background: rgba(255, 255, 255, 0.04);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .author-bio h3 {
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-tertiary);
      margin: 0 0 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .author-bio p {
      font-family: var(--font-serif);
      font-size: 14px;
      line-height: 1.6;
      color: var(--text-secondary);
      margin: 0;
    }

    /* Subscribe Box - neutral, no color theme */
    .subscribe-box {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 24px;
      margin: 32px 0;
      text-align: center;
    }

    .dark-theme .subscribe-box {
      background: var(--bg-tertiary);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .subscribe-title {
      font-family: var(--font-serif);
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 8px;
    }

    .subscribe-box-text {
      font-family: var(--font-serif);
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 16px;
    }

    .subscribe-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      max-width: 360px;
      margin: 0 auto;
    }

    .subscribe-input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-family: var(--font-sans);
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .subscribe-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .subscribe-btn {
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 15px;
      font-weight: 600;
      font-family: var(--font-sans);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .subscribe-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }

    .subscribe-terms {
      font-family: var(--font-sans);
      font-size: 11px;
      color: var(--text-tertiary);
      margin-top: 10px;
    }

    /* Share Buttons */
    .share-section {
      margin: 24px 0;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }

    .share-title {
      font-family: var(--font-sans);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 0 0 16px;
    }

    .share-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .share-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-family: var(--font-sans);
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s ease;
    }

    .dark-theme .share-btn {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .share-btn:hover {
      background: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .share-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .article-layout {
        padding: 20px 16px 40px;
      }

      .article-title {
        font-size: 28px;
      }

      .article-subtitle {
        font-size: 16px;
      }

      .article-content h1 {
        font-size: 28px;
        margin: 24px 0 16px;
      }

      .article-content h2 {
        font-size: 22px;
        margin: 20px 0 16px;
      }

      .back-to-top {
        bottom: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
      }
    }
  </style>
</head>
<body>
  <div class="progress-bar" id="progressBar"></div>

  <div class="page-wrapper">
    <header class="site-header" id="siteHeader">
  <div class="site-header-content">
    <a href="/" class="site-logo">
      <img src="/assets/images/logo-writing-book.svg" alt="" class="site-logo-icon" width="36" height="36">
      <span class="site-logo-text">xxntti3n</span>
    </a>

    <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle menu">
      <span class="hamburger"></span>
      <span class="hamburger"></span>
      <span class="hamburger"></span>
    </button>

    <nav class="site-nav" id="siteNav">
      <a href="/" class="nav-link">Home</a>
      <a href="/kubernetes/" class="nav-link">Kubernetes</a>
      <a href="/iceberg/" class="nav-link">Iceberg</a>
      <a href="/about/" class="nav-link">About</a>
      <a href="https://github.com/xxntti3n" target="_blank" rel="noopener" class="nav-link nav-link--external">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.236 3.221-1.236 4.608 0 2.807 1.803 5.626 5.469 5.921-.43.372-.823 1.102-.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
        GitHub
      </a>

      <!-- Dark mode toggle -->
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
        <svg class="theme-icon sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
        <svg class="theme-icon moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display: none;">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
        </svg>
      </button>
    </nav>
  </div>

  <script>
    // Mobile menu toggle
    const mobileMenuToggle = document.getElementById('mobileMenuToggle');
    const siteNav = document.getElementById('siteNav');
    const siteHeader = document.getElementById('siteHeader');

    mobileMenuToggle.addEventListener('click', () => {
      mobileMenuToggle.classList.toggle('active');
      siteNav.classList.toggle('active');
      document.body.style.overflow = siteNav.classList.contains('active') ? 'hidden' : '';
    });

    // Close menu when clicking a link
    document.querySelectorAll('.site-nav a').forEach(link => {
      link.addEventListener('click', () => {
        mobileMenuToggle.classList.remove('active');
        siteNav.classList.remove('active');
        document.body.style.overflow = '';
      });
    });

    // Close menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!siteHeader.contains(e.target) && siteNav.classList.contains('active')) {
        mobileMenuToggle.classList.remove('active');
        siteNav.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // Dark mode toggle
    const themeToggle = document.getElementById('themeToggle');
    const sunIcon = themeToggle.querySelector('.sun');
    const moonIcon = themeToggle.querySelector('.moon');

    // Check for saved theme; default to light for consistent UI
    const savedTheme = localStorage.getItem('theme');
    const currentTheme = savedTheme || 'light';

    if (currentTheme === 'dark') {
      document.documentElement.classList.add('dark-theme');
      sunIcon.style.display = 'none';
      moonIcon.style.display = 'block';
    }

    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.classList.toggle('dark-theme');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      sunIcon.style.display = isDark ? 'none' : 'block';
      moonIcon.style.display = isDark ? 'block' : 'none';
    });
  </script>
</header>

<style>
  .site-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border-light);
    transition: all 0.2s ease;
  }

  .dark-theme .site-header {
    background: rgba(13, 17, 23, 0.95);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  .site-header-content {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 24px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 64px;
  }

  .site-logo {
    display: flex;
    align-items: center;
    gap: 12px;
    text-decoration: none;
  }

  .site-logo-icon {
    width: 36px;
    height: 36px;
    border-radius: 8px;
    display: block;
    object-fit: contain;
    /* Logo is black; invert in dark theme so it stays visible */
  }

  .dark-theme .site-logo-icon {
    filter: invert(1) brightness(1.1);
  }

  .site-logo-text {
    font-family: var(--font-sans);
    font-weight: 700;
    font-size: 16px;
    color: var(--text-primary);
  }

  .dark-theme .site-logo-text {
    color: #f0f6fc;
  }

  .mobile-menu-toggle {
    display: none;
    flex-direction: column;
    gap: 5px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    z-index: 101;
  }

  .mobile-menu-toggle .hamburger {
    width: 24px;
    height: 2px;
    background: var(--text-primary);
    border-radius: 2px;
    transition: all 0.3s ease;
  }

  .dark-theme .mobile-menu-toggle .hamburger {
    background: #f0f6fc;
  }

  .mobile-menu-toggle.active .hamburger:nth-child(1) {
    transform: rotate(45deg) translate(5px, 5px);
  }

  .mobile-menu-toggle.active .hamburger:nth-child(2) {
    opacity: 0;
  }

  .mobile-menu-toggle.active .hamburger:nth-child(3) {
    transform: rotate(-45deg) translate(5px, -5px);
  }

  .site-nav {
    display: flex;
    align-items: center;
    gap: 24px;
  }

  .site-nav .nav-link {
    font-family: var(--font-sans);
    font-size: 14px;
    font-weight: 500;
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.2s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .dark-theme .site-nav .nav-link {
    color: #8b949e;
  }

  .site-nav .nav-link:hover {
    color: var(--accent);
  }

  .site-nav .nav-link--external {
    opacity: 0.8;
  }

  .theme-toggle {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: var(--bg-tertiary);
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    color: var(--text-secondary);
  }

  .dark-theme .theme-toggle {
    background: rgba(255, 255, 255, 0.1);
    color: #f0f6fc;
  }

  .theme-toggle:hover {
    background: var(--accent);
    color: white;
  }

  @media (max-width: 768px) {
    .mobile-menu-toggle {
      display: flex;
    }

    .site-nav {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      flex-direction: column;
      gap: 0;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      transform: translateY(-100%);
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
      max-height: calc(100vh - 64px);
      overflow-y: auto;
    }

    .dark-theme .site-nav {
      background: #0d1117;
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .site-nav.active {
      transform: translateY(0);
      opacity: 1;
      visibility: visible;
    }

    .site-nav .nav-link {
      padding: 14px 0;
      font-size: 16px;
      border-bottom: 1px solid var(--border-light);
    }

    .dark-theme .site-nav .nav-link {
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .site-nav .nav-link:last-child {
      border-bottom: none;
    }

    .theme-toggle {
      margin-top: 16px;
      width: 100%;
      height: 44px;
    }
  }
</style>


    <div class="container" style="padding-top: 20px;">
      
      
      <a href="/iceberg/" class="article-back-link">← Back to Iceberg</a>
      
      <nav class="breadcrumbs" aria-label="Breadcrumb" style="padding-bottom: 8px;">
        <a href="/">Home</a>
        <span>/</span>
        
        
        <a href="/iceberg/">Iceberg</a>
        <span>/</span>
        
        <span class="current">Iceberg Compaction and Maintenance — Deep Dive</span>
      </nav>
    </div>

    <main class="article-layout">
      <!-- TOC Sidebar -->
      
      <aside class="toc-sidebar">
        <div class="toc-title">Table of Contents</div>
        <nav class="toc-list" id="tocList">
          <!-- TOC items will be generated by JavaScript -->
        </nav>
      </aside>
      

      <!-- Article Content -->
      <article>
        <header class="article-header">
          <h1 class="article-title">Iceberg Compaction and Maintenance — Deep Dive</h1>
          
          <div class="article-meta">
            <div class="article-author">
              <div class="article-author-avatar">TN</div>
              <div class="article-author-info">
                <span class="article-author-name">Tien Nguyen</span>
                <span class="article-date">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <path d="M16 2v4M12 5l7 7"/>
                  </svg>
                  Feb 18, 2025
                </span>
              </div>
            </div>
            
            <span class="article-reading-time">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <polyline points="12 6 12 12 16 14"/>
              </svg>
              12 min read
            </span>
            
          </div>
        </header>

        <div class="article-content">
          <p>Keeping Iceberg tables healthy means expiring old snapshots, rewriting manifests and data files when needed, and removing orphan files. This post covers what each operation does and when to run it, with concrete examples.</p>

<hr />

<h2 id="1-why-maintenance-matters">1. Why maintenance matters</h2>

<ul>
  <li><strong>Snapshots</strong> accumulate with every commit; without expiration, metadata grows and time-travel history can become huge.</li>
  <li><strong>Manifests</strong> can become many small files; rewriting them improves planning and pruning.</li>
  <li><strong>Data files</strong> can become small and numerous (e.g. after many small writes or merge-on-read); rewriting consolidates them and can apply delete files so future reads are cheaper.</li>
  <li><strong>Orphan files</strong> (leftover from failed jobs or old snapshots) waste storage and should be removed with care.</li>
</ul>

<hr />

<h2 id="2-expire-snapshots">2. Expire snapshots</h2>

<p><strong>What it does</strong>: Removes snapshot entries from metadata older than a given time (or beyond a retention policy). Data files that are <strong>only</strong> referenced by expired snapshots become candidates for physical deletion (e.g. by a separate orphan file cleanup).</p>

<p><strong>Example (Spark procedure style):</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">expire_snapshots</span><span class="p">(</span>
  <span class="k">table</span> <span class="o">=&gt;</span> <span class="s1">'db.orders'</span><span class="p">,</span>
  <span class="n">older_than</span> <span class="o">=&gt;</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2024-01-01 00:00:00'</span>
<span class="p">);</span>
</code></pre></div></div>

<p><strong>Example (Java API):</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">table</span><span class="o">.</span><span class="na">expireSnapshots</span><span class="o">()</span>
     <span class="o">.</span><span class="na">expireOlderThan</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">-</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000L</span><span class="o">)</span>
     <span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</code></pre></div></div>

<p><strong>Best practice</strong>: Run regularly (e.g. daily) with a retention window that matches your time-travel and compliance needs (e.g. 7 days).</p>

<hr />

<h2 id="3-rewrite-manifests">3. Rewrite manifests</h2>

<p><strong>What it does</strong>: Combines small manifest files into fewer, larger manifests. Improves planning and partition pruning because the engine reads fewer, better-organized manifest files.</p>

<p><strong>When</strong>: After many small commits (e.g. streaming) when you have a large number of manifest files.</p>

<p><strong>Example (Spark procedure):</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">rewrite_manifests</span><span class="p">(</span><span class="s1">'db.orders'</span><span class="p">);</span>
</code></pre></div></div>

<hr />

<h2 id="4-rewrite-data-files-compaction">4. Rewrite data files (compaction)</h2>

<p><strong>What it does</strong>: Reads a set of data files (and their delete files), merges them into fewer, larger data files, and optionally applies delete files so the new files have no delete files (merge-on-read → copy-on-write for those rows). Reduces small-file count and read-time merge cost.</p>

<p><strong>When</strong>: After many small writes or when merge-on-read has accumulated many delete files.</p>

<p><strong>Example (Spark procedure):</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">rewrite_data_files</span><span class="p">(</span>
  <span class="k">table</span> <span class="o">=&gt;</span> <span class="s1">'db.orders'</span><span class="p">,</span>
  <span class="k">where</span> <span class="o">=&gt;</span> <span class="s1">'partition = 20240101'</span>
<span class="p">);</span>
</code></pre></div></div>

<p>You can limit scope by partition or run full-table rewrite; the procedure picks files to combine based on size/count.</p>

<hr />

<h2 id="5-remove-old-metadata-files">5. Remove old metadata files</h2>

<p>Each commit creates a new metadata file. Old metadata files can be removed once no longer needed for history. Some catalogs or table properties support “delete previous metadata after commit” (e.g. keep last N). Untracked or very old metadata files can be removed by <strong>orphan file deletion</strong> (see below) if your tool supports it and you’re careful not to delete the current one.</p>

<hr />

<h2 id="6-delete-orphan-files">6. Delete orphan files</h2>

<p><strong>What it does</strong>: Deletes files in the table directory that are not referenced by any valid snapshot or metadata (e.g. leftover from failed writes or expired snapshots).</p>

<p><strong>When</strong>: Run after expiring snapshots and with a safety horizon (e.g. only delete files older than 24 hours) to avoid removing in-progress writes.</p>

<p><strong>Example (Spark procedure):</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CALL</span> <span class="k">catalog</span><span class="p">.</span><span class="k">system</span><span class="p">.</span><span class="n">remove_orphan_files</span><span class="p">(</span>
  <span class="k">table</span> <span class="o">=&gt;</span> <span class="s1">'db.orders'</span><span class="p">,</span>
  <span class="n">older_than</span> <span class="o">=&gt;</span> <span class="nb">TIMESTAMP</span> <span class="s1">'2024-01-15 00:00:00'</span>
<span class="p">);</span>
</code></pre></div></div>

<p><strong>Caution</strong>: Ensure no concurrent jobs are still writing; use a conservative <code class="language-plaintext highlighter-rouge">older_than</code> so you don’t delete active files.</p>

<hr />

<h2 id="7-suggested-maintenance-schedule">7. Suggested maintenance schedule</h2>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Frequency</th>
      <th>Purpose</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Expire snapshots</td>
      <td>Daily</td>
      <td>Limit history and free unreferenced data</td>
    </tr>
    <tr>
      <td>Rewrite manifests</td>
      <td>Weekly or as needed</td>
      <td>Reduce manifest count</td>
    </tr>
    <tr>
      <td>Rewrite data files</td>
      <td>Weekly or as needed</td>
      <td>Consolidate small files, apply deletes</td>
    </tr>
    <tr>
      <td>Remove orphan files</td>
      <td>After expire_snapshots</td>
      <td>Clean storage</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="8-summary">8. Summary</h2>

<table>
  <thead>
    <tr>
      <th>Operation</th>
      <th>Effect</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Expire snapshots</td>
      <td>Drop old versions from metadata; allow file cleanup</td>
    </tr>
    <tr>
      <td>Rewrite manifests</td>
      <td>Fewer, larger manifest files</td>
    </tr>
    <tr>
      <td>Rewrite data files</td>
      <td>Fewer, larger data files; apply delete files</td>
    </tr>
    <tr>
      <td>Remove orphan files</td>
      <td>Delete unreferenced files in table location</td>
    </tr>
  </tbody>
</table>

<p>For how snapshots and expiration interact with time travel, see <a href="/iceberg/snapshots-time-travel/">Snapshots and Time Travel</a>. For how row-level deletes and merge-on-read work, see <a href="/iceberg/row-level-updates-deletes/">Row-Level Updates and Deletes</a>.</p>

        </div>

        <!-- Share Section -->
        <div class="share-section">
          <div class="share-title">Share this article</div>
          <div class="share-buttons">
            <a href="https://twitter.com/intent/tweet?text=Iceberg+Compaction+and+Maintenance+%E2%80%94+Deep+Dive&url=https://xxntti3n.github.io%2Ficeberg%2Fcompaction-and-maintenance%2F" target="_blank" rel="noopener" class="share-btn">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M18.244 2.25h3.308l-2.684 8.016h-2.588l2.348-7.288h-4.016l-3.328 12h6.624l2.184-7.288h4.516l-2.684-8.016h-3.544l-2.5 8.016h-3.568l-2.268 8.016h3.544l2.5-8.016h3.56l2.268-8.016h-3.544z"/>
              </svg>
              Twitter
            </a>
            <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://xxntti3n.github.io%2Ficeberg%2Fcompaction-and-maintenance%2F" target="_blank" rel="noopener" class="share-btn">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
              </svg>
              LinkedIn
            </a>
            <a href="https://github.com/xxntti3n" target="_blank" rel="noopener" class="share-btn">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.236 3.221-1.236 4.608 0 2.807 1.803 5.626 5.469 5.921-.43.372-.823 1.102-.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
              </svg>
              GitHub
            </a>
          </div>
        </div>

        <!-- Author Bio -->
        <div class="author-bio">
          <h3>About the Author</h3>
          <p><strong>Tien Nguyen</strong> is a software engineer exploring distributed systems, cloud infrastructure, and developer tools. Writes about production learnings and technical deep dives across cloud-native platforms, container orchestration, and modern software development practices.</p>
        </div>

        <!-- Subscribe Box -->
        <div class="subscribe-box">
          <h3 class="subscribe-title">Enjoyed this article?</h3>
          <p class="subscribe-box-text">Subscribe to get weekly technical guides and engineering insights delivered to your inbox. No spam, just signal.</p>
          <form class="subscribe-form" id="subscribeForm">
            <input type="email" placeholder="your@email.com" required class="subscribe-input">
            <button type="submit" class="subscribe-btn">Subscribe</button>
          </form>
          <p class="subscribe-terms">By subscribing, you agree to receive emails. Unsubscribe anytime.</p>
        </div>
      </article>
    </main>

    <footer class="site-footer">
  <div class="footer-content">
    <p class="footer-text">&copy; 2026 xxntti3n. Built with <a href="https://jekyllrb.com/" style="color: inherit;">Jekyll</a> & <a href="https://pages.github.com/" style="color: inherit;">GitHub Pages</a>.</p>
    <div class="social-links">
      <a href="https://linkedin.com/in/xxntti3n" target="_blank" rel="noopener" aria-label="LinkedIn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
        </svg>
      </a>
      <a href="https://github.com/xxntti3n" target="_blank" rel="noopener" aria-label="GitHub">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.236 3.221-1.236 4.608 0 2.807 1.803 5.626 5.469 5.921-.43.372-.823 1.102-.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
        </svg>
      </a>
      <a href="/feed.xml" aria-label="RSS Feed">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.18 15.64a2.18 2.18 0 0 1 2.18 2.18C8.36 19.43 7.39 20.4 6.18 20.4a2.18 2.18 0 0 1-2.18-2.18c0-1.21.97-2.18 2.18-2.18zM2 10.1a12 12 0 0 1 12 12 12 12 0 0 1 3.53-8.43 12 12 0 0 1-3.53-8.43H12A10 10 0 0 0 2 10.1zm0-5.9a17.9 17.9 0 0 1 17.9 17.9 17.9 17.9 0 0 1 5.27 12.69A17.9 17.9 0 0 1 12 22.07V20a16 16 0 0 0 4.71-11.34A16 16 0 0 0 12 2v2.1z"/>
        </svg>
      </a>
    </div>
  </div>
</footer>

<style>
  .site-footer {
    background: var(--bg-secondary);
    border-top: 1px solid var(--border);
    padding: 40px 0;
    margin-top: auto;
    transition: background-color 0.3s ease;
  }

  .dark-theme .site-footer {
    background: var(--bg-secondary);
    border-top-color: rgba(255, 255, 255, 0.1);
  }

  .footer-content {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 24px;
    text-align: center;
  }

  .footer-text {
    font-family: var(--font-sans);
    font-size: 13px;
    color: var(--text-tertiary);
    margin: 0;
  }

  .dark-theme .footer-text {
    color: #6e7681;
  }

  .social-links {
    display: flex;
    justify-content: center;
    gap: 16px;
    margin-top: 16px;
  }

  .social-links a {
    color: var(--text-secondary);
    text-decoration: none;
    transition: color 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: var(--bg-tertiary);
    transition: all 0.2s ease;
  }

  .dark-theme .social-links a {
    background: rgba(255, 255, 255, 0.05);
    color: #8b949e;
  }

  .social-links a:hover {
    color: var(--accent);
    transform: translateY(-2px);
  }

  .social-links a svg {
    width: 18px;
    height: 18px;
  }

  @media (max-width: 600px) {
    .social-links a {
      width: 36px;
      height: 36px;
    }

    .social-links a svg {
      width: 16px;
      height: 16px;
    }
  }
</style>

  </div>

  <button class="back-to-top" id="backToTop" aria-label="Back to top">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 19V5M5 12l7-7 7 7"/>
    </svg>
  </button>

  <script>
    // Progress bar
    const progressBar = document.getElementById('progressBar');
    const backToTop = document.getElementById('backToTop');

    window.addEventListener('scroll', function() {
      const scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
      const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
      const progress = Math.min((scrollTop / scrollHeight) * 100, 100);
      progressBar.style.width = progress + '%';

      if (window.pageYOffset > 500) {
        backToTop.classList.add('visible');
      } else {
        backToTop.classList.remove('visible');
      }
    });

    backToTop.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Generate Table of Contents
    document.addEventListener('DOMContentLoaded', function() {
      const tocList = document.getElementById('tocList');
      const content = document.querySelector('.article-content');

      if (!tocList || !content) return;

      const headings = content.querySelectorAll('h2');
      let sectionNumber = 1;

      headings.forEach(function(heading) {
        // Add ID to heading if missing
        if (!heading.id) {
          const text = heading.textContent.trim();
          const baseId = text.toLowerCase().replace(/[^a-z0-9]+/g, '-');
          heading.id = baseId || 'section-' + sectionNumber;
        }

        // Create TOC item
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent.trim();
        li.appendChild(a);
        tocList.appendChild(li);

        sectionNumber++;
      });

      // Active state on scroll
      const tocLinks = tocList.querySelectorAll('a');
      window.addEventListener('scroll', function() {
        let current = '';
        headings.forEach(function(heading) {
          const sectionTop = heading.offsetTop;
          if (window.pageYOffset >= sectionTop - 150) {
            current = heading.id;
          }
        });

        tocLinks.forEach(function(link) {
          link.classList.remove('active');
          if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
          }
        });
      });
    });

    // Subscribe form
    const subscribeForm = document.getElementById('subscribeForm');
    if (subscribeForm) {
      subscribeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        alert('Thanks for subscribing!');
      });
    }
  </script>
</body>
</html>
